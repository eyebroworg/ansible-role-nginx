---
# SSL/TLS security configuration for nginx

- name: Ensure SSL certificates directory exists
  ansible.builtin.file:
    path: "{{ nginx_ssl_certs_path }}"
    state: directory
    owner: root
    group: "{{ root_group }}"
    mode: '0755'

# =============================================================================
# DH Parameters Generation
# =============================================================================
- name: Generate DH parameters
  when: nginx_ssl_dhparam_enabled | bool
  block:
    - name: Check if DH parameters file exists
      ansible.builtin.stat:
        path: "{{ nginx_ssl_dhparam_path }}"
      register: _dhparam_stat

    - name: Generate DH parameters (this may take a while on low-spec machines)
      ansible.builtin.command:
        cmd: openssl dhparam -out {{ nginx_ssl_dhparam_path }} {{ nginx_ssl_dhparam_bits }}
        creates: "{{ nginx_ssl_dhparam_path }}"
      async: "{{ nginx_ssl_dhparam_async_timeout }}"
      poll: 10
      when: not _dhparam_stat.stat.exists
      notify: reload nginx

    - name: Set permissions on DH parameters file
      ansible.builtin.file:
        path: "{{ nginx_ssl_dhparam_path }}"
        owner: root
        group: "{{ root_group }}"
        mode: '0644'
      when: _dhparam_stat.stat.exists or not ansible_check_mode

# =============================================================================
# Self-signed Certificate for Default Server
# =============================================================================
- name: Generate self-signed certificate for default server
  when: nginx_ssl_default_cert_enabled | bool
  block:
    - name: Ensure default certificate directory exists
      ansible.builtin.file:
        path: "{{ nginx_ssl_default_cert_path }}"
        state: directory
        owner: root
        group: "{{ root_group }}"
        mode: '0755'

    - name: Check if default certificate exists
      ansible.builtin.stat:
        path: "{{ nginx_ssl_default_cert_path }}/cert.pem"
      register: _default_cert_stat

    - name: Generate self-signed certificate for default server
      ansible.builtin.command:
        cmd: >
          openssl req -x509 -nodes -newkey rsa:2048
          -days {{ nginx_ssl_default_cert_days }}
          -keyout {{ nginx_ssl_default_cert_path }}/key.pem
          -out {{ nginx_ssl_default_cert_path }}/cert.pem
          -subj "/CN={{ nginx_ssl_default_cert_cn }}"
        creates: "{{ nginx_ssl_default_cert_path }}/cert.pem"
      when: not _default_cert_stat.stat.exists
      notify: reload nginx

    - name: Set permissions on default certificate files
      ansible.builtin.file:
        path: "{{ nginx_ssl_default_cert_path }}/{{ item.name }}"
        owner: root
        group: "{{ root_group }}"
        mode: "{{ item.mode }}"
      loop:
        - { name: 'cert.pem', mode: '0644' }
        - { name: 'key.pem', mode: '0600' }
      when: not _default_cert_stat.stat.exists or not ansible_check_mode

# =============================================================================
# SSL Configuration Snippet
# =============================================================================
- name: Deploy SSL configuration snippet
  ansible.builtin.template:
    src: ssl-params.conf.j2
    dest: "{{ nginx_conf_path }}/ssl-params.conf"
    owner: root
    group: "{{ root_group }}"
    mode: '0644'
  notify: reload nginx

# =============================================================================
# Default Server Block (catches unmatched requests)
# =============================================================================
- name: Deploy default server block
  ansible.builtin.template:
    src: default-server.conf.j2
    dest: "{{ nginx_conf_path }}/00-default-server.conf"
    owner: root
    group: "{{ root_group }}"
    mode: '0644'
  when: nginx_default_server_enabled | bool
  notify: reload nginx

- name: Remove default server block if disabled
  ansible.builtin.file:
    path: "{{ nginx_conf_path }}/00-default-server.conf"
    state: absent
  when: not (nginx_default_server_enabled | bool)
  notify: reload nginx
