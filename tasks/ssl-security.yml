---
# SSL/TLS security configuration for nginx

- name: Ensure SSL certificates directory exists
  ansible.builtin.file:
    path: "{{ nginx_ssl_certs_path }}"
    state: directory
    owner: root
    group: "{{ root_group }}"
    mode: '0755'

# Ensure conf.d exists (cleanup may remove it)
- name: Ensure nginx conf.d directory exists
  ansible.builtin.file:
    path: "{{ nginx_conf_path }}"
    state: directory
    owner: root
    group: "{{ root_group }}"
    mode: '0755'

# =============================================================================
# DH Parameters Generation
# =============================================================================
# DH parameters are only needed for TLSv1.2 (intermediate policy).
# TLSv1.3 uses ECDHE exclusively, so dhparam is not required for modern policy.
- name: Generate DH parameters
  when:
    - nginx_ssl_dhparam_enabled | bool
    - nginx_ssl_policy != 'modern'
  block:
    - name: Check if DH parameters file exists
      ansible.builtin.stat:
        path: "{{ nginx_ssl_certs_path }}/dhparam.pem"
      register: _dhparam_stat

    - name: Generate DH parameters (this may take a while on low-spec machines)
      ansible.builtin.command:
        cmd: openssl dhparam -out {{ nginx_ssl_certs_path }}/dhparam.pem 2048
        creates: "{{ nginx_ssl_certs_path }}/dhparam.pem"
      async: 600
      poll: 10
      when: not _dhparam_stat.stat.exists
      notify: Reload nginx

    - name: Set permissions on DH parameters file
      ansible.builtin.file:
        path: "{{ nginx_ssl_certs_path }}/dhparam.pem"
        owner: root
        group: "{{ root_group }}"
        mode: '0644'
      when: _dhparam_stat.stat.exists or not ansible_check_mode

# =============================================================================
# Self-signed Certificate for Default Server
# =============================================================================
- name: Generate self-signed certificate for default server
  when: nginx_ssl_default_cert_enabled | bool
  block:
    - name: Ensure default certificate directory exists
      ansible.builtin.file:
        path: "{{ nginx_ssl_certs_path }}/default"
        state: directory
        owner: root
        group: "{{ root_group }}"
        mode: '0755'

    - name: Check if default certificate exists
      ansible.builtin.stat:
        path: "{{ nginx_ssl_certs_path }}/default/cert.pem"
      register: _default_cert_stat

    - name: Generate self-signed certificate for default server
      ansible.builtin.command:
        cmd: >
          openssl req -x509 -nodes -newkey rsa:2048
          -days 3650
          -keyout {{ nginx_ssl_certs_path }}/default/key.pem
          -out {{ nginx_ssl_certs_path }}/default/cert.pem
          -subj "/CN=localhost"
        creates: "{{ nginx_ssl_certs_path }}/default/cert.pem"
      when: not _default_cert_stat.stat.exists
      notify: Reload nginx

    - name: Set permissions on default certificate files
      ansible.builtin.file:
        path: "{{ nginx_ssl_certs_path }}/default/{{ item.name }}"
        owner: root
        group: "{{ root_group }}"
        mode: "{{ item.mode }}"
      loop:
        - { name: 'cert.pem', mode: '0644' }
        - { name: 'key.pem', mode: '0600' }
      when: not _default_cert_stat.stat.exists or not ansible_check_mode

# =============================================================================
# SSL Configuration Snippet
# =============================================================================
- name: Deploy SSL configuration snippet
  ansible.builtin.template:
    src: ssl-params.conf.j2
    dest: "{{ nginx_conf_path }}/ssl-params.conf"
    owner: root
    group: "{{ root_group }}"
    mode: '0644'
  notify: Reload nginx

# =============================================================================
# Default Server Block (catches unmatched requests)
# =============================================================================
- name: Deploy default server block
  ansible.builtin.template:
    src: default-server.conf.j2
    dest: "{{ nginx_conf_path }}/00-default-server.conf"
    owner: root
    group: "{{ root_group }}"
    mode: '0644'
  when: nginx_default_server_enabled | bool
  notify: Reload nginx

- name: Remove default server block if disabled
  ansible.builtin.file:
    path: "{{ nginx_conf_path }}/00-default-server.conf"
    state: absent
  when: not (nginx_default_server_enabled | bool)
  notify: Reload nginx
