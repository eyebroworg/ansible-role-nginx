---
# SSL Certificate distribution via Ansible Vault

- name: Deploy certificates from vault
  when: nginx_vault_certificates | length > 0
  block:
    - name: Create certificate directories for each domain
      ansible.builtin.file:
        path: "{{ nginx_ssl_certs_path }}/{{ item.domain }}"
        state: directory
        owner: root
        group: "{{ root_group }}"
        mode: '0755'
      loop: "{{ nginx_vault_certificates }}"
      loop_control:
        label: "{{ item.domain }}"

    - name: Deploy SSL certificates
      ansible.builtin.copy:
        content: "{{ item.cert }}"
        dest: "{{ nginx_ssl_certs_path }}/{{ item.domain }}/cert.pem"
        owner: root
        group: "{{ root_group }}"
        mode: '0644'
      loop: "{{ nginx_vault_certificates }}"
      loop_control:
        label: "{{ item.domain }}"
      notify: reload nginx
      no_log: true

    - name: Deploy SSL private keys
      ansible.builtin.copy:
        content: "{{ item.key }}"
        dest: "{{ nginx_ssl_certs_path }}/{{ item.domain }}/key.pem"
        owner: root
        group: "{{ root_group }}"
        mode: '0600'
      loop: "{{ nginx_vault_certificates }}"
      loop_control:
        label: "{{ item.domain }}"
      notify: reload nginx
      no_log: true
