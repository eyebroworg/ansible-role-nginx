#!/bin/bash
# Cloudflare IP update script for nginx real_ip configuration
# Managed by Ansible - eyebrowkang.nginx role
# This script fetches Cloudflare IP ranges and updates nginx configuration

set -euo pipefail

CONFIG_FILE="{{ nginx_cloudflare_real_ip_config }}"
TEMP_FILE="${CONFIG_FILE}.tmp"
REAL_IP_HEADER="{{ nginx_cloudflare_real_ip_header }}"

# Cloudflare API endpoints
CF_IPV4_URL="https://www.cloudflare.com/ips-v4"
CF_IPV6_URL="https://www.cloudflare.com/ips-v6"

# Function to fetch IPs with retry
fetch_ips() {
    local url="$1"
    local max_retries=3
    local retry=0

    while [ $retry -lt $max_retries ]; do
        if result=$(curl -s --connect-timeout 10 --max-time 30 "$url" 2>/dev/null); then
            if [ -n "$result" ]; then
                echo "$result"
                return 0
            fi
        fi
        retry=$((retry + 1))
        sleep 2
    done
    return 1
}

# Create temporary configuration file
cat > "$TEMP_FILE" << 'HEADER'
# Cloudflare Real IP Configuration
# Managed by cloudflare-update-ips.sh
# Last updated: $(date -Iseconds)
#
# This file is automatically generated - do not edit manually
# Changes will be overwritten on next update

HEADER

echo "# Last updated: $(date -Iseconds)" >> "$TEMP_FILE"
echo "" >> "$TEMP_FILE"

# Fetch and add IPv4 addresses
echo "# Cloudflare IPv4 addresses" >> "$TEMP_FILE"
if ipv4_list=$(fetch_ips "$CF_IPV4_URL"); then
    while IFS= read -r ip; do
        if [ -n "$ip" ]; then
            echo "set_real_ip_from $ip;" >> "$TEMP_FILE"
        fi
    done <<< "$ipv4_list"
else
    echo "# Failed to fetch IPv4 addresses" >> "$TEMP_FILE"
    exit 1
fi

echo "" >> "$TEMP_FILE"

# Fetch and add IPv6 addresses
echo "# Cloudflare IPv6 addresses" >> "$TEMP_FILE"
if ipv6_list=$(fetch_ips "$CF_IPV6_URL"); then
    while IFS= read -r ip; do
        if [ -n "$ip" ]; then
            echo "set_real_ip_from $ip;" >> "$TEMP_FILE"
        fi
    done <<< "$ipv6_list"
else
    echo "# Failed to fetch IPv6 addresses" >> "$TEMP_FILE"
    exit 1
fi

echo "" >> "$TEMP_FILE"

# Add real_ip_header directive
echo "# Use the ${REAL_IP_HEADER} header from Cloudflare" >> "$TEMP_FILE"
echo "real_ip_header ${REAL_IP_HEADER};" >> "$TEMP_FILE"

# Validate nginx configuration with the new file
if nginx -t 2>/dev/null; then
    # Move temporary file to final location
    mv "$TEMP_FILE" "$CONFIG_FILE"

    # Reload nginx if it's running
    if systemctl is-active --quiet nginx 2>/dev/null; then
        systemctl reload nginx
    elif service nginx status >/dev/null 2>&1; then
        service nginx reload
    fi

    echo "Cloudflare IP configuration updated successfully"
else
    rm -f "$TEMP_FILE"
    echo "Nginx configuration validation failed, keeping existing configuration"
    exit 1
fi
