#!/bin/bash
# Cloudflare IP update script for nginx real_ip configuration
# Managed by Ansible - eyebrowkang.nginx role
# This script fetches Cloudflare IP ranges and updates nginx configuration
#
# Usage: cloudflare-update-ips.sh [--no-reload]
#   --no-reload  Skip nginx validation and reload (useful during initial setup)

set -euo pipefail

CONFIG_FILE="{{ nginx_cloudflare_real_ip_config }}"
TEMP_FILE="${CONFIG_FILE}.tmp"
REAL_IP_HEADER="{{ nginx_cloudflare_real_ip_header }}"

# Parse arguments
NO_RELOAD=false
for arg in "$@"; do
    case $arg in
        --no-reload)
            NO_RELOAD=true
            shift
            ;;
    esac
done

# Cloudflare API endpoints
CF_IPV4_URL="https://www.cloudflare.com/ips-v4"
CF_IPV6_URL="https://www.cloudflare.com/ips-v6"

# Function to fetch IPs with retry
fetch_ips() {
    local url="$1"
    local max_retries=3
    local retry=0

    while [ $retry -lt $max_retries ]; do
        if result=$(curl -s --connect-timeout 10 --max-time 30 "$url" 2>/dev/null); then
            if [ -n "$result" ]; then
                echo "$result"
                return 0
            fi
        fi
        retry=$((retry + 1))
        sleep 2
    done
    return 1
}

# Create temporary configuration file
cat > "$TEMP_FILE" << EOF
# Cloudflare Real IP Configuration
# Managed by cloudflare-update-ips.sh
# Last updated: $(date -Iseconds)
#
# This file is automatically generated - do not edit manually
# Changes will be overwritten on next update

EOF

# Fetch and add IPv4 addresses
echo "# Cloudflare IPv4 addresses" >> "$TEMP_FILE"
if ipv4_list=$(fetch_ips "$CF_IPV4_URL"); then
    while IFS= read -r ip; do
        if [ -n "$ip" ]; then
            echo "set_real_ip_from $ip;" >> "$TEMP_FILE"
        fi
    done <<< "$ipv4_list"
else
    echo "# Failed to fetch IPv4 addresses" >> "$TEMP_FILE"
    exit 1
fi

echo "" >> "$TEMP_FILE"

# Fetch and add IPv6 addresses
echo "# Cloudflare IPv6 addresses" >> "$TEMP_FILE"
if ipv6_list=$(fetch_ips "$CF_IPV6_URL"); then
    while IFS= read -r ip; do
        if [ -n "$ip" ]; then
            echo "set_real_ip_from $ip;" >> "$TEMP_FILE"
        fi
    done <<< "$ipv6_list"
else
    echo "# Failed to fetch IPv6 addresses" >> "$TEMP_FILE"
    exit 1
fi

echo "" >> "$TEMP_FILE"

# Add real_ip_header directive
echo "# Use the ${REAL_IP_HEADER} header from Cloudflare" >> "$TEMP_FILE"
echo "real_ip_header ${REAL_IP_HEADER};" >> "$TEMP_FILE"

# Handle reload based on --no-reload flag
if [ "$NO_RELOAD" = true ]; then
    # Just move the file without validation/reload (used during initial Ansible deployment)
    mv "$TEMP_FILE" "$CONFIG_FILE"
    echo "Cloudflare IP configuration generated successfully (reload skipped)"
else
    # Backup existing configuration if it exists
    BACKUP_FILE=""
    if [ -f "$CONFIG_FILE" ]; then
        BACKUP_FILE="${CONFIG_FILE}.bak"
        cp "$CONFIG_FILE" "$BACKUP_FILE"
    fi

    # Move new configuration into place
    mv "$TEMP_FILE" "$CONFIG_FILE"

    # Validate nginx configuration with the new file
    if nginx -t 2>/dev/null; then
        # Validation passed, remove backup and reload nginx
        [ -n "$BACKUP_FILE" ] && rm -f "$BACKUP_FILE"

        # Reload nginx if it's running
        if systemctl is-active --quiet nginx 2>/dev/null; then
            systemctl reload nginx
        elif service nginx status >/dev/null 2>&1; then
            service nginx reload
        fi

        echo "Cloudflare IP configuration updated successfully"
    else
        # Validation failed, rollback to previous configuration
        echo "Nginx configuration validation failed"
        if [ -n "$BACKUP_FILE" ] && [ -f "$BACKUP_FILE" ]; then
            mv "$BACKUP_FILE" "$CONFIG_FILE"
            echo "Rolled back to previous configuration"
        else
            rm -f "$CONFIG_FILE"
            echo "Removed invalid configuration"
        fi
        exit 1
    fi
fi
