# Kernel parameters optimized for nginx web server
# Managed by Ansible - eyebrowkang.nginx role

# =============================================================================
# Network Core Settings
# =============================================================================

# Increase the maximum number of connections that can be queued for acceptance
net.core.somaxconn = 65535

# Increase the maximum number of packets queued on the INPUT side
net.core.netdev_max_backlog = 65535

# Increase the maximum receive/send buffer size
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216

# =============================================================================
# TCP Settings
# =============================================================================

# TCP receive/send buffer sizes (min, default, max)
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216

# Enable TCP Fast Open for both incoming and outgoing connections
net.ipv4.tcp_fastopen = 3

# Reduce TIME_WAIT connections
net.ipv4.tcp_fin_timeout = 15
net.ipv4.tcp_tw_reuse = 1

# Increase the maximum number of orphaned TCP sockets
net.ipv4.tcp_max_orphans = 65535

# Increase the maximum SYN backlog
net.ipv4.tcp_max_syn_backlog = 65535

# Enable TCP window scaling
net.ipv4.tcp_window_scaling = 1

# Disable TCP slow start after idle
net.ipv4.tcp_slow_start_after_idle = 0

# Enable TCP keepalive with reasonable defaults
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_intvl = 60
net.ipv4.tcp_keepalive_probes = 3

# =============================================================================
# Connection Tracking (for reverse proxy scenarios)
# =============================================================================

# Increase connection tracking table size (if nf_conntrack module is loaded)
# These are commented by default as they require nf_conntrack module
# net.netfilter.nf_conntrack_max = 1048576
# net.netfilter.nf_conntrack_tcp_timeout_established = 600

# =============================================================================
# File Descriptors
# =============================================================================

# Increase the maximum number of file descriptors
fs.file-max = 2097152

# =============================================================================
# Virtual Memory
# =============================================================================

# Reduce swappiness for better performance
vm.swappiness = 10

# Increase the percentage of memory that can be used for dirty pages
vm.dirty_ratio = 40
vm.dirty_background_ratio = 10
